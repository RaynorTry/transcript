<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê—Ä—Ö–∏–≤ —Ç–∏–∫–µ—Ç–æ–≤</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg: #1e1e1e;
            --card: #2d2d2d;
            --soft: #3a3a3a;
            --text: #e0e0e0;
            --muted: #a0a0a0;
            --accent: #4d90ff;
            --header-bg: #252525;
            --header-text: #ffffff;
            --filter-bg: #333333;
            --border: #404040;
        }
        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            padding: 0;
        }
        #login-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: var(--bg);
            color: var(--text);
            text-align: center;
            padding: 2rem;
        }
        #login-container h2 {
            margin-bottom: 1rem;
            color: var(--header-text);
        }
        #login-btn {
            background: #5865F2;
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .ticket-link:hover {
            text-decoration: underline;
        }
        #back-to-tickets-btn {
            margin-bottom: 1rem;
            padding: 0.5rem 1rem;
            background: #4d90ff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div id="login-container">
        <h2>üîê –î–æ—Å—Ç—É–ø –∫ –∞—Ä—Ö–∏–≤—É —Ç–∏–∫–µ—Ç–æ–≤</h2>
        <p>–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Discord, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –≤—Å–µ —Ç–∏–∫–µ—Ç—ã.</p>
        <button id="login-btn">
            <svg width="20" height="20" viewBox="0 0 127.14 96.36" style="fill:currentColor">
                <path d="M107.7,8.07A105.15,105.15,0,0,0,81.47,0a72.06,72.06,0,0,0-3.36,6.83A97.68,97.68,0,0,0,49,6.83,72.37,72.37,0,0,0,45.64,0,105.89,105.89,0,0,0,19.39,8.09C2.79,32.65-1.71,56.6.54,80.21h0A105.73,105.73,0,0,0,32.71,96.36,77.7,77.7,0,0,0,39.6,85.25a68.42,68.42,0,0,1-10.85-5.18c.91-.66,1.8-1.34,2.66-2a75.57,75.57,0,0,0,64.32,0c.87.71,1.76,1.39,2.66,2a68.68,68.68,0,0,1-10.87,5.19,77,77,0,0,0,6.89,11.1A105.25,105.25,0,0,0,126.6,80.22h0C129.24,52.84,122.09,29.11,107.7,8.07ZM42.45,65.69C36.18,65.69,31,60,31,53s5-12.74,11.43-12.74S54,46,53.89,53,48.84,65.69,42.45,65.69Zm42.24,0C78.41,65.69,73.25,60,73.25,53s5-12.74,11.44-12.74S96.23,46,96.12,53,91.08,65.69,84.69,65.69Z"/>
            </svg>
            –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Discord
        </button>
    </div>

    <div id="content-container" style="display: none;">
        <header style="background: var(--header-bg); color: var(--header-text); padding: 1rem; display: flex; justify-content: space-between; align-items: center;">
            <h1>–ê—Ä—Ö–∏–≤ —Ç–∏–∫–µ—Ç–æ–≤</h1>
            <div>
                <button id="logout-btn" style="padding: 0.5rem 1rem; background: #d9534f; color: white; border: none; border-radius: 4px; cursor: pointer;">–í—ã–π—Ç–∏</button>
                <button id="show-feedback-btn" style="margin-left: 0.5rem; padding: 0.5rem 1rem; background: #f0ad4e; color: white; border: none; border-radius: 4px; cursor: pointer;">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç–∑—ã–≤—ã</button>
            </div>
        </header>
        <div class="controls">
            <div class="search-box">
                <input type="text" id="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ç–∏–∫–µ—Ç–∞–º...">
            </div>
            <select id="category">
                <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                <option value="–ñ–∞–ª–æ–±–∞-–Ω–∞-–∏–≥—Ä–æ–∫–∞">–ñ–∞–ª–æ–±–∞-–Ω–∞-–∏–≥—Ä–æ–∫–∞</option>
<option value="–ñ–∞–ª–æ–±–∞-–Ω–∞-—Å–æ—Å—Ç–∞–≤–∞">–ñ–∞–ª–æ–±–∞-–Ω–∞-—Å–æ—Å—Ç–∞–≤–∞</option>
<option value="–û–¥–æ–±—Ä–µ–Ω–∏–µ-–≤–∞—Ä–ø–∞">–û–¥–æ–±—Ä–µ–Ω–∏–µ-–≤–∞—Ä–ø–∞</option>
<option value="–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ-–ø—Ä–æ–±–ª–µ–º—ã">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ-–ø—Ä–æ–±–ª–µ–º—ã</option>

            </select>
            <select id="priority">
                <option value="">–í—Å–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã</option>
                <option value="low">üü¢ –ù–∏–∑–∫–∏–π</option>
                <option value="medium">üü° –°—Ä–µ–¥–Ω–∏–π</option>
                <option value="high">üü† –í—ã—Å–æ–∫–∏–π</option>
                <option value="critical">üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π</option>
            </select>
            <select id="sort">
                <option value="date">–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –¥–∞—Ç–µ</option>
                <option value="messages">–ü–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Å–æ–æ–±—â–µ–Ω–∏–π</option>
            </select>
        </div>
        <div id="ticket-list" class="ticket-grid">
            <!-- –°–ø–∏—Å–æ–∫ —Ç–∏–∫–µ—Ç–æ–≤ -->
        </div>
        <div id="feedback-container" style="display: none; padding: 2rem 1rem; max-width: 1400px; margin: 0 auto;">
            <!-- –û—Ç–∑—ã–≤—ã -->
        </div>
        <button id="back-to-tickets-btn" style="display: none;">–ù–∞–∑–∞–¥ –∫ —Ç–∏–∫–µ—Ç–∞–º</button>
        <footer style="color: var(--muted); font-size: 0.875rem; text-align: center; padding: 2rem; border-top: 1px solid var(--border); margin-top: 2rem;">
            <p>–ê—Ä—Ö–∏–≤ —Ç–∏–∫–µ—Ç–æ–≤</p>
            <p>–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏. –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∑–∞–∫—Ä—ã—Ç—ã–º —Ç–∏–∫–µ—Ç–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è.</p>
        </footer>
    </div>

    <script>
        const supabaseUrl = 'https://zzuywzjxsiggpjrblzcb.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp6dXl3emp4c2lnZ3BqcmJsemNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2NDEwNDYsImV4cCI6MjA3NDIxNzA0Nn0.ZBodjmJ6zRvqh6-eFVIKN83Z6TYxSelW13E46t93LJw';
        if (typeof window.supabase === 'undefined') {
            document.getElementById('login-container').innerHTML = `<h2 style="color: #d9534f;">‚ùå –û—à–∏–±–∫–∞</h2><p>Supabase SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω.</p>`;
            console.error("Supabase SDK –Ω–µ –Ω–∞–π–¥–µ–Ω.");
        } else {
            const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
            const loginContainer = document.getElementById('login-container');
            const contentContainer = document.getElementById('content-container');
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const showFeedbackBtn = document.getElementById('show-feedback-btn');
            const backToTicketsBtn = document.getElementById('back-to-tickets-btn');
            const ticketsGrid = document.getElementById('tickets-grid');
            const feedbackContainer = document.getElementById('feedback-container');
            const ADMIN_IDS = ["457254057816489984","855078703225372702"];
            const { data } = await supabase.auth.getSession();
            const session = data.session;
            updateUI(session);
            supabase.auth.onAuthStateChange((event, session) => {
                updateUI(session);
            });
            async function signInWithDiscord() {
                const { error } = await supabase.auth.signInWithOAuth({
                    provider: 'discord',
                    options: { redirectTo: window.location.origin }
                });
                if (error) alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message);
            }
            async function signOut() {
                await supabase.auth.signOut();
                window.location.reload();
            }
            function updateUI(session) {
                if (session) {
                    const user = session.user;
                    const userId = String(user.id);
                    console.log("–í–∞—à Discord ID:", userId); // üëà –≠–¢–ê –°–¢–†–û–ö–ê
                    console.log("–ê–¥–º–∏–Ω-–ª–∏—Å—Ç:", ADMIN_IDS); // üëà –≠–¢–ê –°–¢–†–û–ö–ê
                    const isAdmin = ADMIN_IDS.includes(userId);
                    console.log("isAdmin:", isAdmin); // üëà –≠–¢–ê –°–¢–†–û–ö–ê
                    if (!isAdmin) {
                        // ... –ø–æ–∫–∞–∑ "–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω"
                        loginContainer.innerHTML = `<h2 style="color: #d9534f;">‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω</h2><p>–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∞—Ä—Ö–∏–≤–∞.</p><button onclick="signOut()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #d9534f; color: white; border: none; border-radius: 4px; cursor: pointer;">–í—ã–π—Ç–∏</button>`;
                    } else {
                        loginContainer.style.display = 'none';
                        contentContainer.style.display = 'block';
                        loadTickets();
                    }
                } else {
                    loginContainer.style.display = 'flex';
                    contentContainer.style.display = 'none';
                }
            }
            loginBtn.addEventListener('click', signInWithDiscord);
            logoutBtn.addEventListener('click', signOut);
            showFeedbackBtn.addEventListener('click', loadFeedback);
            backToTicketsBtn.addEventListener('click', () => {
                feedbackContainer.style.display = 'none';
                document.querySelector('.ticket-grid').style.display = 'grid';
                backToTicketsBtn.style.display = 'none';
            });
            async function loadTickets() {
                const container = document.querySelector('.ticket-grid');
                container.innerHTML = '<p style="text-align: center; color: var(--muted); grid-column: 1 / -1;">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∏–∫–µ—Ç–æ–≤...</p>';
                try {
                    const response = await fetch('https://raw.githubusercontent.com/RaynorTry/transcript/main/tickets.json');
                    if (!response.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å tickets.json');
                    const ticketsData = await response.json();
                    if (ticketsData.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: var(--muted); grid-column: 1 / -1;">–ù–µ—Ç —Ç–∏–∫–µ—Ç–æ–≤.</p>';
                        return;
                    }
                    container.innerHTML = '';
                    ticketsData.forEach(ticket => {
                        const card = document.createElement('div');
                        card.className = 'ticket-card';
                        card.dataset.category = ticket.category;
                        card.dataset.priority = ticket.priority;
                        card.dataset.messages = ticket.messages;
                        card.innerHTML = `
                            <div class="ticket-header">
                                <a href="transcript-${ticket.slug}.html" class="ticket-title ticket-link">#${ticket.number}</a>
                                <span style="color: ${ticket.priority_color};">${ticket.priority_emoji} ${ticket.priority_label}</span>
                            </div>
                            <div class="ticket-meta">
                                <div><strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> ${ticket.category}</div>
                                <div><strong>–û—Ç–∫—Ä—ã–ª:</strong> ${ticket.opened_by}</div>
                                <div><strong>–ù–∞–∑–Ω–∞—á–µ–Ω:</strong> ${ticket.assigned_to}</div>
                                <div><strong>–°–æ–æ–±—â–µ–Ω–∏–π:</strong> ${ticket.messages}</div>
                                <div><strong>–í–ª–æ–∂–µ–Ω–∏–π:</strong> ${ticket.attachments}</div>
                                <div><strong>–û—Ç–∫—Ä—ã—Ç:</strong> ${new Date(ticket.opened_at * 1000).toLocaleString('ru-RU')}</div>
                                <div><strong>–ó–∞–∫—Ä—ã—Ç:</strong> ${ticket.is_closed ? new Date(ticket.closed_at * 1000).toLocaleString('ru-RU') : '–ù–µ –∑–∞–∫—Ä—ã—Ç'}</div>
                            </div>
                            <div class="ticket-footer">
                                <span>${ticket.is_closed ? 'üîí –ó–∞–∫—Ä—ã—Ç' : 'üîì –û—Ç–∫—Ä—ã—Ç'}</span>
                                <a href="transcript-${ticket.slug}.html" class="view-btn">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å</a>
                            </div>
                        `;
                        container.appendChild(card);
                    });
                    filterTickets();
                } catch (error) {
                    container.innerHTML = `<p style="text-align: center; color: #d9534f; grid-column: 1 / -1;">–û—à–∏–±–∫–∞: ${error.message}</p>`;
                }
            }
            async function loadFeedback() {
                feedbackContainer.innerHTML = '<p style="text-align: center; color: var(--muted); grid-column: 1 / -1;">–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–∑—ã–≤–æ–≤...</p>';
                try {
                    const response = await fetch('https://gist.githubusercontent.com/RaynorTry/e09a956f06b4cb86b0d4182b1325289e/raw/feedback.json');
                    if (!response.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å feedback.json');
                    const feedbackData = await response.json();
                    if (feedbackData.length === 0) {
                        feedbackContainer.innerHTML = '<p style="text-align: center; color: var(--muted); grid-column: 1 / -1;">–ù–µ—Ç –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã—Ö –æ—Ç–∑—ã–≤–æ–≤.</p>';
                        return;
                    }
                    feedbackContainer.innerHTML = '';
                    feedbackData.forEach(feedback => {
                        const card = document.createElement('div');
                        card.className = 'feedback-card';
                        card.innerHTML = `
                            <div class="feedback-header">
                                <div><strong>–û—Ü–µ–Ω–∫–∞:</strong> ${'‚≠ê'.repeat(feedback.rating)} (${feedback.rating}/5)</div>
                                <div><strong>–û—Ç–∫—Ä—ã–ª:</strong> ${feedback.opened_by}</div>
                            </div>
                            <div class="feedback-meta">
                                <div><strong>–ù–∞–∑–Ω–∞—á–µ–Ω:</strong> ${feedback.assigned_to}</div>
                                <div><strong>–î–∞—Ç–∞:</strong> ${new Date(feedback.timestamp * 1000).toLocaleString('ru-RU')}</div>
                            </div>
                            <div class="feedback-comment">
                                <strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong>
                                <p>${feedback.comment}</p>
                            </div>
                        `;
                        feedbackContainer.appendChild(card);
                    });
                } catch (error) {
                    feedbackContainer.innerHTML = `<p style="text-align: center; color: #d9534f; grid-column: 1 / -1;">–û—à–∏–±–∫–∞: ${error.message}</p>`;
                }
                document.querySelector('.ticket-grid').style.display = 'none';
                feedbackContainer.style.display = 'block';
                backToTicketsBtn.style.display = 'block';
            }
            function filterTickets() {
                const searchValue = document.getElementById('search').value.toLowerCase();
                const categoryValue = document.getElementById('category').value;
                const priorityValue = document.getElementById('priority').value;
                const cards = document.querySelectorAll('.ticket-card');
                cards.forEach(card => {
                    const title = card.querySelector('.ticket-title').textContent.toLowerCase();
                    const category = card.dataset.category;
                    const priority = card.dataset.priority;
                    const isVisible = title.includes(searchValue) && (categoryValue === '' || category === categoryValue) && (priorityValue === '' || priority === priorityValue);
                    card.style.display = isVisible ? 'block' : 'none';
                });
            }
            function sortTickets() {
                const container = document.querySelector('.ticket-grid');
                const sortBy = document.getElementById('sort').value;
                const cards = Array.from(container.querySelectorAll('.ticket-card'));
                cards.sort((a, b) => {
                    let aValue, bValue;
                    if (sortBy === 'date') {
                        aValue = parseInt(a.querySelector('.ticket-meta div:last-child').textContent.split(': ')[1]);
                        bValue = parseInt(b.querySelector('.ticket-meta div:last-child').textContent.split(': ')[1]);
                    } else if (sortBy === 'messages') {
                        aValue = parseInt(a.dataset.messages);
                        bValue = parseInt(b.dataset.messages);
                    }
                    return bValue - aValue;
                });
                container.innerHTML = '';
                cards.forEach(card => container.appendChild(card));
            }
            const searchInput = document.getElementById('search');
            const categorySelect = document.getElementById('category');
            const prioritySelect = document.getElementById('priority');
            const sortSelect = document.getElementById('sort');
            if (searchInput) searchInput.addEventListener('input', filterTickets);
            if (categorySelect) categorySelect.addEventListener('change', filterTickets);
            if (prioritySelect) prioritySelect.addEventListener('change', filterTickets);
            if (sortSelect) sortSelect.addEventListener('change', sortTickets);
        }
    </script>
</body>
</html>